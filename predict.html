<html>

<head>
  <title>minimal demo</title>
  <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css'
    rel='stylesheet'>

  <script src='https://code.jquery.com/jquery-2.1.3.js'></script>
  <!-- import convnetjs library -->
  <script src='convnet-min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.symbol.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.categories.min.js'></script>

  <!-- javascript goes here -->
</head>

<body>
  <div>
    <select id='player-blue'></select>
    <select id='player-red'></select>
    <input type='text' name='time' id='time'></input>
    <p id='btn-predict'
      class='btn btn-default'
      type='button'>Predict</p>
  </div>
  <div id='chart-dist'
    style='width:400px;height:300px'></div>
  <script type='text/javascript'>
    function do_training(data) {
      var opts = {}; // options struct
      opts.train_ratio = 0.7;
      opts.num_folds = 1; // number of folds to eval per candidate
      opts.num_candidates = 20; // number of candidates to eval in parallel
      opts.num_epochs = 10; // epochs to make through data per fold
      opts.neurons_max = 50;

      var players = $.unique($.merge($.map(data, function(g) {
        return g.blue.name;
      }), $.map(data, function(g) {
        return g.red.name;
      })));
      players.sort();
      $.each(players, function(i, p) {
        $('#player-blue').append('<option value="' + p + '">' + p + '</option>');
        $('#player-red').append('<option value="' + p + '">' + p + '</option>');
      });
      var results = [];
      for (var b = 0; b <= 10; b++) {
        var result = b + ':' + (10 - b);
        results.push(b + ':' + (10 - b));
        $('#row-header').append('<th>' + result + '</th>');
      }

      function hotK(elements, element) {
        var result = [];
        var index = elements.indexOf(element);
        for (var i = 0; i < elements.length; i++) {
          result.push(i === index ? 1.0 : 0.0);
        }
        return result;
      }
      var train_data = $.map(data, function(g) {
        return new convnetjs.Vol($.merge(hotK(players, g.blue.name), hotK(players, g.red.name)));
      });
      // console.log(train_data);
      var train_labels = $.map(data, function(g) {
        return results.indexOf(g.blue.score + ':' + g.red.score);
      });

      // console.log(train_labels);
      var magicNet = new convnetjs.MagicNet(train_data, train_labels, opts);
      magicNet.onFinishBatch(finishedBatch); // example of setting callback for events

      // start training magicNet. Every step() call all candidates train on one example
      setInterval(function() {
        magicNet.step();
      }, 0);

      // once at least one batch of candidates is evaluated on all folds we can do prediction!
      function finishedBatch() {
        console.log('finished batch...');
      }

      var options = {
        series: {
          bars: {
            show: true,
            align: 'center',
            barWidth: 0.5
          }
        },
        xaxis: {
          mode: 'categories',
          tickLength: 0
        },
        yaxis: {
          min: 0,
          max: 1
        },
        grid: {
          hoverable: true,
          borderWidth: 2,
          backgroundColor: {
            colors: ['#ffffff', '#EDF5FF']
          }
        }
      };
      var initialData = $.map(results, function(o, i) {
          return [[o, 1 / results.length]];
      });
      var plot = $.plot($('#chart-dist'), [ initialData ], options);

      $('#btn-predict').click(function() {
        // var time = parseInt($('#time').val());
        var blue = $('#player-blue').val();
        var red = $('#player-red').val();

        var vol = new convnetjs.Vol($.merge(hotK(players, blue), hotK(players, red)));
        var predicted = magicNet.predict_soft(vol);
        var data = $.map(predicted.w, function(o, i) {
            // Stop flattening me jquery.
            return [[results[i], o]];
        });
        var cu = 0;
        var data_cu = $.map(predicted.w, function(o, i) {
            // Stop flattening me jquery.
            cu += o;
            return [[results[i], cu]];
        });
        plot.setData([data, data_cu]);
        plot.setupGrid();
        plot.draw();
      });

    }

    jQuery.ajax({
      url: 'ladder.cgi',
      datatype: 'json',
      success: function(data, status, jqXHR) {
        do_training(data);
      }
    });
  </script>
</body>

</html>
